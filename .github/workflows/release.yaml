name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release-*
    paths:
      - charts/fluentd/Chart.yaml

permissions: read-all

jobs:
  check:
    name: Check if fluentd needs release
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.check.outputs.release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check fluentd version
        id: check
        run: |
          set -euo pipefail
          chart="fluentd"
          current_version=$(grep "^version:" charts/${chart}/Chart.yaml | awk '{print $2}')
          chart_name=$(grep "^name:" charts/${chart}/Chart.yaml | awk '{print $2}')

          # Check if tag already exists
          if git tag -l "${chart_name}-${current_version}" | grep -q .; then
            echo "Tag ${chart_name}-${current_version} already exists, skipping release"
            echo "release=false" >> $GITHUB_OUTPUT
          else
            echo "Will release ${chart_name}-${current_version}"
            echo "release=true" >> $GITHUB_OUTPUT
            echo "version=${current_version}" >> $GITHUB_OUTPUT
          fi

  release:
    name: Release fluentd chart
    needs: check
    if: needs.check.outputs.release == 'true'
    runs-on: ubuntu-latest
    permissions:
      attestations: write
      contents: write
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Get chart info
        id: chart
        run: |
          chart_name=$(grep "^name:" charts/fluentd/Chart.yaml | awk '{print $2}')
          chart_version=$(grep "^version:" charts/fluentd/Chart.yaml | awk '{print $2}')
          echo "name=${chart_name}" >> $GITHUB_OUTPUT
          echo "version=${chart_version}" >> $GITHUB_OUTPUT

      - name: Package chart
        run: |
          helm package charts/fluentd --destination .cr-release-packages

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to OCI registry
        run: |
          helm push .cr-release-packages/${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz oci://ghcr.io/${{ github.repository }}

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extract release notes for current version from CHANGELOG.md
          version="${{ steps.chart.outputs.version }}"
          changelog_file="charts/fluentd/CHANGELOG.md"

          if [[ -f "${changelog_file}" ]]; then
            # Extract content between version header and next header
            notes=$(awk "/## \\[v${version}\\]/{flag=1; next} /## \\[/{flag=0} flag" "${changelog_file}" | head -50)
            if [[ -n "${notes}" ]]; then
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "${notes}" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "notes=Release ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "notes=Release ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}
          name: ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          files: .cr-release-packages/${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz
          make_latest: true

      - name: Publish to GitHub Pages
        run: |
          set -euo pipefail

          # Configure git
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          # Save the packaged chart
          mkdir -p /tmp/charts
          cp .cr-release-packages/*.tgz /tmp/charts/

          # Checkout gh-pages branch (create if doesn't exist)
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git fetch origin gh-pages
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Helm Charts" > README.md
          fi

          # Copy chart package
          cp /tmp/charts/*.tgz .

          # Update Helm repo index
          if [[ -f index.yaml ]]; then
            helm repo index . --merge index.yaml --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          else
            helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          fi

          # Commit and push
          git add .
          git commit -m "Release ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}"
          git push origin gh-pages
